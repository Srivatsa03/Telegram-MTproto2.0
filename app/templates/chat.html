{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-3">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 border-end">
      <h5>Chats</h5>
      <button onclick="deleteChat()" class="btn btn-sm btn-outline-danger ms-2">
        üóëÔ∏è Clear Chat
      </button>
      <ul id="chatList" class="list-group"></ul>
    </div>

    <!-- Chat Window -->
    <div class="col-md-9">
      <h5 id="chatWith">Select a user to start chatting</h5>
      <div id="chatModeLabel" class="mb-2 text-muted"></div>

      <!-- Chat Mode Selector -->
      <div class="mb-3">
        <label for="chatMode">Chat Mode:</label>
        <select id="chatMode" class="form-select w-auto d-inline" onchange="handleChatModeChange()">
          <option value="cloud">Cloud Chat</option>
          <option value="secret">Secret Chat</option>
        </select>
        <button id="initiateSecretBtn" class="btn btn-sm btn-warning ms-2" style="display: none;" onclick="initiateSecretForCurrentUser()">üîê Initiate Secret Chat</button>
      </div>

      <div id="userStatus" class="text-muted mb-2"></div>

      <!-- Cloud Chat Box -->
      <div id="cloudChatBox" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background: #f9f9f9; display: none;">
        <!-- Cloud messages go here -->
      </div>

      <!-- Secret Chat Box -->
      <div id="secretChatBox" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background: #f9f9f9; display: none;">
        <!-- Secret messages go here -->
      </div>

      <div id="typingStatus" class="mb-2 text-muted" style="display: none;"></div>

      <div class="d-flex gap-2 mb-2">
        <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>

      <div class="mt-2">
        <label>Attach File / Image:</label>
        <input type="file" class="form-control" onchange="sendFile(this)">
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="receiverId">

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Secret Chat Scripts -->
<script src="{{ url_for('static', filename='js/secret_chat_dh.js') }}"></script>
<script src="{{ url_for('static', filename='js/secret_chat_crypto.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>

<script>
  // Handle mode switching in UI
  function handleChatModeChange() {
    const mode = document.getElementById("chatMode").value;
    setChatMode(mode);
    const initiateBtn = document.getElementById("initiateSecretBtn");

    const cloudBox = document.getElementById("cloudChatBox");
    const secretBox = document.getElementById("secretChatBox");

    if (mode === "secret") {
      cloudBox.style.display = "none";
      secretBox.style.display = "block";
      initiateBtn.style.display = "inline-block";
    } else {
      cloudBox.style.display = "block";
      secretBox.style.display = "none";
      initiateBtn.style.display = "none";
    }
  }

  // Trigger DH key exchange for Secret Chat
  function initiateSecretForCurrentUser() {
    const receiverId = document.getElementById("receiverId").value;
    if (!receiverId) {
      alert("Select a user first!");
      return;
    }
    initiateSecretChat(parseInt(receiverId));
  }
</script>

{% endblock %}